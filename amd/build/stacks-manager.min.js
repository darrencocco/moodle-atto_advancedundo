define(["core/log"],function(a){var b={};b.undoStack=[],b.redoStack=[],b.lastKnownState=null,b.locked=!1,b.maxUndos=40,b.appendUndo=function(b){if(this.locked)return{action:"AppendRejected",undoStackSize:this.undoStack.length,redoStackSize:this.redoStack.length};var c=this.cleanHtml(b.editorContent);for(null===this.lastKnownState?c!==this.undoStack[this.undoStack.length-1]&&(this.undoStack.push(c),a.debug("Undo retained")):this.lastKnownState!==c&&(this.undoStack.push(c),a.debug("Undo retained"),this.lastKnownState=null,this.redoStack=[],a.debug("Redo stack cleared"));this.undoStack.length>this.maxUndos;)this.undoStack.shift();return{action:"UndoRetained",undoStackSize:this.undoStack.length,redoStackSize:this.redoStack.length}},b.getRedo=function(a){if(this.locked=!0,this.redoStack.length<1)return{action:"RedoNoDelta",undoStackSize:this.undoStack.length,redoStackSize:this.redoStack.length};var b=this.cleanHtml(a.editorContent),c=this.redoStack.pop();return b===c?{action:"RedoNoDelta",undoStackSize:this.undoStack.length,redoStackSize:this.redoStack.length}:(this.undoStack.push(b),this.lastKnownState=c,{action:"RedoSupplied",contentToRestore:c,undoStackSize:this.undoStack.length,redoStackSize:this.redoStack.length})},b.getUndo=function(a){this.locked=!0;var b=this.cleanHtml(a.editorContent),c=this._getUndo(b);return b===c?{action:"UndoNoDelta",undoStackSize:this.undoStack.length,redoStackSize:this.redoStack.length}:(this.redoStack.push(b),this.lastKnownState=c,{action:"UndoSupplied",contentToRestore:c,undoStackSize:this.undoStack.length,redoStackSize:this.redoStack.length})},b._getUndo=function(a){if(1===this.undoStack.length)return this.undoStack[0];if(null!==this.lastKnownState)return a!==this.lastKnownState?a:this.undoStack.pop();var b=this.undoStack.pop();return b!==a?b:this.undoStack.pop()},b.cleanHtml=function(a){if("<p></p>"===a||"<p><br></p>"===a)return"";var b=[{regex:/(<[^>]*) +id="yui[^"]*"([^>]*>)/gi,replace:"$1$2"},{regex:/<style[^>]*>[\s\S]*?<\/style>/gi,replace:""},{regex:/<!--(?![\s\S]*?-->)/gi,replace:""},{regex:/<\/?(?:title|meta|style|st\d|head|font|html|body|link)[^>]*?>/gi,replace:""}];return a=this._filterContentWithRules(a,b)},b.unlock=function(){this.locked=!1},b._filterContentWithRules=function(a,b){var c=0;for(c=0;c<b.length;c++)a=a.replace(b[c].regex,b[c].replace);return a},onmessage=function(a){switch(a.data.action){case"AppendUndo":postMessage(b.appendUndo(a.data));break;case"GetRedo":postMessage(b.getRedo(a.data));break;case"GetUndo":postMessage(b.getUndo(a.data));break;case"Unlock":b.unlock()}}});